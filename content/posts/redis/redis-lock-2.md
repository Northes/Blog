---
title: "Redis 实现分布式锁"
date: 2024-06-20T21:23:28+08:00
draft: true
author : "Northes"
description: "使用Redis实现分布式锁的七种方案"
tags: ["学习笔记","Redis"]
---

日常开发中，秒杀下单、抢红包等业务场景，都需要用到分布式锁。而Redis非常适合作为分布式锁使用。

## 分布式锁的特征

1. 互斥性：任意时刻，只有一个客户端能持有锁
2. 锁超时释放：持有锁超时，可以释放，防止不必要的资源浪费，也可以防止死锁
3. 可重入性：一个线程如果获取了锁之后，可以再次对其请求加锁
4. 高性能和高可用：加锁和解锁需要开销尽可能低，同时也要保证高可用，避免分布式锁失效。
5. 安全性：锁只能被原持有的客户端删除，不能被其他客户端删除。

## SETNX + EXPIRE

SETNX 是SET IF NOT EXISTS的简写.日常命令格式是SETNX key value，如果 key不存在，则SETNX成功返回1，如果这个key已经存在了，则返回0。

但是这个方案中，`SETNX` 和 `EXPIRE` 分开了，不是原子操作。如果执行完setnx加锁，正要执行expire设置过期时间时，进程crash或者要重启维护了，那么这个锁就“长生不老”了，别的线程永远获取不到锁啦。

## SETNX + value 值为时间戳

解决了设置超时失败的情况下，获取不到锁的问题。获取不到的时候将时间戳拿出来判断一下，如果超时了，就可以删除key。

仍然存在问题：

1. 过期时间是客户端自己生成的（System.currentTimeMillis()是当前系统的时间），必须要求分布式环境下，每个客户端的时间必须同步。 
2. 如果锁过期的时候，并发多个客户端同时请求过来，都执行jedis.getSet()，最终只能有一个客户端加锁成功，但是该客户端锁的过期时间，可能被别的客户端覆盖 
3. 该锁没有保存持有者的唯一标识，可能被别的客户端释放/解锁。

## 使用 LUA 脚本（包含 SETNX + EXPIRE两条指令）

```lua
if redis.call('setnx',KEYS[1],ARGV[1]) == 1 then
   redis.call('expire',KEYS[1],ARGV[2])
else
   return 0
end;
```

## SET 扩展命令（SET EX PX NX）

```bash
SET key value[EX seconds][PX milliseconds][NX|XX]
```

这条命令也是原子性的

NX :表示key不存在的时候，才能set成功，也即保证只有第一个客户端请求才能获得锁，而其他客户端请求只能等其释放锁，才能获取。

EX seconds :设定key的过期时间，时间单位是秒。

PX milliseconds: 设定key的过期时间，单位为毫秒

XX: 仅当key存在时设置值


存在问题：

问题一：锁过期释放了，业务还没执行完。假设线程a获取锁成功，一直在执行临界区的代码。但是100s过去后，它还没执行完。但是，这时候锁已经过期了，此时线程b又请求过来。显然线程b就可以获得锁成功，也开始执行临界区的代码。那么问题就来了，临界区的业务代码都不是严格串行执行的啦。

问题二：锁被别的线程误删。假设线程a执行完后，去释放锁。但是它不知道当前的锁可能是线程b持有的（线程a去释放锁时，有可能过期时间已经到了，此时线程b进来占有了锁）。那线程a就把线程b的锁释放掉了，但是线程b临界区业务代码可能都还没执行完呢。

## SET EX PX NX + 校验唯一随机值,再删除

加唯一值防止被别的线程误删

```lua
if redis.call('get',KEYS[1]) == ARGV[1] then 
   return redis.call('del',KEYS[1]) 
else
   return 0
end;
```

## Redisson 框架

只要线程一加锁成功，就会启动一个 `watch dog` 看门狗，他是一个后台线程，每隔一段时间检查一下，如果线程1还持有锁，就会不断延长锁key的生存时间。

因此，Redisson 解决了锁过期释放，业务没有执行完的问题。

## 多机实现的分布式锁 Redlock + Redisson

1. 搭建5个master节点，并且互相独立，不会同步数据
2. 按顺序向5个master节点请求加锁 
3. 根据设置的超时时间来判断，是不是要跳过该master节点。 
4. 如果大于等于三个节点加锁成功，并且使用的时间小于锁的有效期，即可认定加锁成功啦。 
5. 如果获取锁失败，解锁！

## 参考

- https://juejin.cn/post/6936956908007850014